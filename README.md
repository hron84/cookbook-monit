# Monit cookbook

# Requirements

This cookbook is not requires any external cookbook.

# Usage

## M/Monit server

Simply add `monit` and `monit::mmonit` to run list. Recipe uses Monit to start M/Monit, so
be sure `monit` is added before `monit::mmonit`.

# Attributes

 - `node[:mmonit][:version]` - M/Monit version. Default: `2.4`
 - `node[:mmonit][:checksum]` - M/Monit package checksum. If custom version is specified, this attribute is have to be filled

 - `node[:monit][:check_interval]` - Instructs Monit how often check services. Default: `120`
 - `node[:monit][:log]` - Where Monit sends messages. If it is 'syslog' then log being sent to syslog. Default: `/var/log/monit.log`
 - `node[:monit][:mailserver][:host]` - Hostname of SMTP server used for deliver alerts. Default: `localhost`
 - `node[:monit][:mailserver][:port]` - Port of SMTP server used for deliver alerts. Note: monit cannot authenticate against this SMTP server. Default: `25`
 - `node[:monit][:httpd][:enable]` - Determines whether HTTP server is enabled or not. Default: `false`
 - `node[:monit][:httpd][:address]` - Address where built-in HTTP  server is listening. Default: `localhost`
 - `node[:monit][:httpd][:port]` - Port where built-in HTTP server is listening. Default: `2812`
 - `node[:monit][:httpd][:user]` - HTTP authentication username. Default: `admin`
 - `node[:monit][:httpd][:password]` - HTTP authentication password. Default: `monit`
 - `node[:monit][:mailformat][:from]` - Alert message sender. Default `root@#{node[:fqdn]}`
 - `node[:monit][:mailformat][:subject]` - Alert message subject template. See [monit documentation](http://mmonit.com/monit/documentation/monit.html#alert_message_layout) for details. Default: `monit alert --  $EVENT $SERVICE`
 - `node[:monit][:mmonit_url]` - M/Monit server's URL. Default: not set.

# Recipes

## default

Installs Monit from package and generates monitrc. Also configures monit to monitor itself - just for test `monit_check` resource.

## monit::mmonit

This recipe downloads and installs an M/Monit server and configures Monit to monitor it. Also creates a service called `mmonit`.

# Resources

## monit_check

This is a service check for monit. It can monitor three type of service:
 - Handled by system, with init scripts or upstart/systemd
 - Same as above, but can monitor one port
 - Handled by monit itself (fully custom)

### Attributes
 - `file_name` - What filename will be created under /etc/monit/conf.d. Name variable. Default: resource name.
 - `group` - Group of service in Monit. Default: not set
 - `process` - What process will be monitored. Monit uses this as a description of service. Default: `file_name` of the resource
 - `service` - If service is handled by system, this name will used to search the service itself. Default: `process`
 - `pidfile` - PID file generated by service. Default `/var/run/#{service}.pid`
 - `start_program` - How to start service if checks failed (service is not running). Default is depends on operating system init script handler.
 - `stop_program` - How to stop service if checks failed (service is not running). Default is depends on operating system init script handler.
 - `host` - If checking a port for the service, this will specify which host will be used. Default: `localhost`
 - `port` - If checking a port for the service, this will specify which port will be used. Default: not set
 - `ssl` - If checking a port for the service, this will specify SSL is used or not. Default: false
 - `protocol` - If checking a port for the service, this will specify which protocol will be used. Default: not set
 - `template` - If we need a custom service template, we can specify which template will be used. It is being searched under `monit` cookbook. Default: `generic_service`

### Examples

```ruby
# Handled by system
monit_check 'monit' do
  action :enable
end

# Handled by system, monitor a port
monit_check 'sshd' do
  if platform?('ubuntu')
    service 'ssh'
    process 'sshd'
    pidfile '/var/run/sshd.pid'
  end

  host 'localhost'
  port '22'
end

# Custom service
monit_check "mmonit" do
  start_program "/opt/mmonit-#{mmonit_version}/bin/mmonit start"
  stop_program "/opt/mmonit-#{mmonit_version}/bin/mmonit stop"
  process "mmonit"
  pidfile "/opt/mmonit-#{mmonit_version}/logs/mmonit.pid"
  port 8080
  protocol 'http'
end

```
# Author

Author:: Garami Gabor (<hron@hron.me>)

# License

Licensed under the terms of MIT License.
